{% extends 'base.html.twig' %}

{% block title %}{% if isNew %}New Paste{% else %}Edit: {{ meta.title }}{% endif %} - Pastebin{% endblock %}

{% block content %}
<header>
    <h1>{% if isNew %}New Paste{% else %}Edit Paste{% endif %}</h1>
    <div class="nav">
        <a href="{{ basePath }}/" class="button">Home</a>
        {% if not isNew %}
            <a href="{{ paste.getHtmlUrl() }}" class="button secondary">View</a>
        {% endif %}
        <a href="{{ basePath }}/logout" class="button secondary">Logout</a>
    </div>
</header>

<form method="post" enctype="multipart/form-data" id="paste-form">
    <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" name="title" value="{{ meta.title }}" required>
    </div>

    <div class="form-group">
        <label for="summary">Summary (shown in paste list)</label>
        <input type="text" id="summary" name="summary" value="{{ meta.summary }}">
    </div>

    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" rows="3">{{ meta.description }}</textarea>
    </div>

    <div class="form-group">
        <label for="author">Author</label>
        <input type="text" id="author" name="author" value="{{ meta.author }}">
    </div>

    <div class="form-group">
        <div class="checkbox-field">
            <input type="checkbox" id="public" name="public" value="1" {% if meta.public %}checked{% endif %}>
            <label for="public">Public (visible to everyone)</label>
        </div>
    </div>

    <div class="form-group">
        <label for="displayMode">Display Mode</label>
        <select id="displayMode" name="displayMode" onchange="updateDisplayModeFields()">
            <option value="multi-normal" {% if meta.displayMode == 'multi-normal' or not meta.displayMode %}selected{% endif %}>Multi File: Normal</option>
            <option value="multi-wide" {% if meta.displayMode == 'multi-wide' %}selected{% endif %}>Multi File: Wide</option>
            <option value="single-normal" {% if meta.displayMode == 'single-normal' %}selected{% endif %}>Single File: Normal</option>
            <option value="single-wide" {% if meta.displayMode == 'single-wide' %}selected{% endif %}>Single File: Wide</option>
        </select>
    </div>

    <div class="form-group hidden" id="selectedFileGroup">
        <label for="selectedFile">Display File</label>
        <select id="selectedFile" name="selectedFile">
            {% if meta.files %}
                {% for filename, fileMeta in meta.files %}
                    <option value="{{ filename }}" {% if meta.selectedFile == filename %}selected{% endif %}>
                        {{ loop.index }}. {{ filename }}{% if fileMeta.displayName %} ({{ fileMeta.displayName }}){% endif %}
                    </option>
                {% endfor %}
            {% endif %}
        </select>
    </div>

    <h2>Files</h2>

    <div id="files-container">
        {% if meta.files %}
            {% for filename, fileMeta in meta.files %}
            <div class="file-editor{% if meta.files|length > 1 %} collapsed{% endif %}" data-file-index="{{ loop.index0 }}" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragend="handleDragEnd(event)">
                <div class="file-editor-header" onclick="toggleFileEditor(event, this)">
                    <div class="file-editor-header-left">
                        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                        <span class="collapse-icon">{% if meta.files|length > 1 %}►︎{% else %}▼{% endif %}</span>
                        <h3>File #{{ loop.index }}</h3>
                        <span class="file-editor-names">{% if meta.files|length > 1 %} - {{ filename }}{% if fileMeta.displayName %} ({{ fileMeta.displayName }}){% endif %}{% if fileMeta.hidden %} <span class="file-hidden-indicator">[Hidden]</span>{% endif %}{% endif %}</span>
                    </div>
                    <button type="button" class="secondary" onclick="event.stopPropagation(); removeFile(this)">Remove</button>
                </div>

                <div class="file-editor-body">
                <input type="hidden" name="files[{{ loop.index0 }}][originalFilename]" value="{{ filename }}">
                <div class="inline-fields">
                    <div class="form-group">
                        <label>Filename</label>
                        <input type="text" name="files[{{ loop.index0 }}][filename]" value="{{ filename }}" required oninput="updateDisplayFileDropdown()">
                    </div>

                    <div class="form-group">
                        <label>Render Mode</label>
                        <select name="files[{{ loop.index0 }}][render]" class="render-select" onchange="updateFileFields(this)">
                            <option value="plain" {% if fileMeta.render == 'plain' %}selected{% endif %}>Plain</option>
                            <option value="highlighted" {% if fileMeta.render == 'highlighted' %}selected{% endif %}>Highlighted</option>
                            <option value="rendered" {% if fileMeta.render == 'rendered' %}selected{% endif %}>Rendered</option>
                            <option value="image" {% if fileMeta.render == 'image' %}selected{% endif %}>Image</option>
                            <option value="file" {% if fileMeta.render == 'file' %}selected{% endif %}>File Download</option>
                            <option value="file-link" {% if fileMeta.render == 'file-link' %}selected{% endif %}>File Link</option>
                            <option value="link" {% if fileMeta.render == 'link' %}selected{% endif %}>List of Links</option>
                        </select>
                    </div>

                    <div class="form-group file-type-field">
                        <label>Type</label>
                        <select name="files[{{ loop.index0 }}][type]" class="type-select">
                            <option value="">Auto-detect</option>
                            <option value="bash" {% if fileMeta.type == 'bash' %}selected{% endif %}>Bash</option>
                            <option value="c" {% if fileMeta.type == 'c' %}selected{% endif %}>C</option>
                            <option value="cpp" {% if fileMeta.type == 'cpp' %}selected{% endif %}>C++</option>
                            <option value="csharp" {% if fileMeta.type == 'csharp' %}selected{% endif %}>C#</option>
                            <option value="css" {% if fileMeta.type == 'css' %}selected{% endif %}>CSS</option>
                            <option value="diff" {% if fileMeta.type == 'diff' %}selected{% endif %}>Diff</option>
                            <option value="go" {% if fileMeta.type == 'go' %}selected{% endif %}>Go</option>
                            <option value="html" {% if fileMeta.type == 'html' %}selected{% endif %}>HTML</option>
                            <option value="java" {% if fileMeta.type == 'java' %}selected{% endif %}>Java</option>
                            <option value="javascript" {% if fileMeta.type == 'javascript' %}selected{% endif %}>JavaScript</option>
                            <option value="json" {% if fileMeta.type == 'json' %}selected{% endif %}>JSON</option>
                            <option value="kotlin" {% if fileMeta.type == 'kotlin' %}selected{% endif %}>Kotlin</option>
                            <option value="markdown" {% if fileMeta.type == 'markdown' %}selected{% endif %}>Markdown</option>
                            <option value="php" {% if fileMeta.type == 'php' %}selected{% endif %}>PHP</option>
                            <option value="python" {% if fileMeta.type == 'python' %}selected{% endif %}>Python</option>
                            <option value="ruby" {% if fileMeta.type == 'ruby' %}selected{% endif %}>Ruby</option>
                            <option value="rust" {% if fileMeta.type == 'rust' %}selected{% endif %}>Rust</option>
                            <option value="sql" {% if fileMeta.type == 'sql' %}selected{% endif %}>SQL</option>
                            <option value="swift" {% if fileMeta.type == 'swift' %}selected{% endif %}>Swift</option>
                            <option value="typescript" {% if fileMeta.type == 'typescript' %}selected{% endif %}>TypeScript</option>
                            <option value="xml" {% if fileMeta.type == 'xml' %}selected{% endif %}>XML</option>
                            <option value="yaml" {% if fileMeta.type == 'yaml' %}selected{% endif %}>YAML</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="files[{{ loop.index0 }}][displayName]">Display Name (optional)</label>
                    <input type="text" id="files[{{ loop.index0 }}][displayName]" name="files[{{ loop.index0 }}][displayName]" value="{{ fileMeta.displayName }}" placeholder="Leave empty to use filename" oninput="updateDisplayFileDropdown()">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <input type="text" name="files[{{ loop.index0 }}][description]" value="{{ fileMeta.description }}">
                </div>

                <div class="form-group">
                    <div class="checkbox-field">
                        <input type="checkbox" id="files[{{ loop.index0 }}][hidden]" name="files[{{ loop.index0 }}][hidden]" value="1" {% if fileMeta.hidden %}checked{% endif %}>
                        <label for="files[{{ loop.index0 }}][hidden]">Hidden (don't show in multi-file mode)</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-field">
                        <input type="checkbox" id="files[{{ loop.index0 }}][unwrapped]" name="files[{{ loop.index0 }}][unwrapped]" value="1" {% if fileMeta.unwrapped %}checked{% endif %}>
                        <label for="files[{{ loop.index0 }}][unwrapped]">Unwrapped (render without file header/wrapper)</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-field">
                        <input type="checkbox" id="files[{{ loop.index0 }}][collapsed]" name="files[{{ loop.index0 }}][collapsed]" value="1" {% if fileMeta.collapsed %}checked{% endif %}>
                        <label for="files[{{ loop.index0 }}][collapsed]">Start collapsed (multi-file mode)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="files[{{ loop.index0 }}][collapsedDescription]">Collapsed Description (optional)</label>
                    <input type="text" id="files[{{ loop.index0 }}][collapsedDescription]" name="files[{{ loop.index0 }}][collapsedDescription]" value="{{ fileMeta.collapsedDescription }}" placeholder="Brief description shown when collapsed">
                </div>

                <div class="form-group file-content-field">
                    <label>Content (or upload file below)</label>
                    <textarea name="files[{{ loop.index0 }}][content]" rows="10">{{ paste.getFile(filename) }}</textarea>
                </div>

                <div class="form-group file-exists-indicator hidden">
                    <label>Current File</label>
                    <div class="existing-file-info">
                        {% set isBinary = paste.isFileBinary(filename) %}
                        <strong>{{ filename }}</strong> {% if isBinary %}(binary file){% else %}exists{% endif %}
                        {% if fileMeta.render == 'image' %}
                        <div class="file-image-preview">
                            <img src="{{ basePath }}/notes/{{ paste.id }}/files/{{ filename }}">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Upload {% if fileMeta.render in ['image', 'file', 'file-link'] %}New {% endif %}File</label>
                    <input type="file" name="file_uploads[{{ loop.index0 }}]">
                </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <button type="button" onclick="addFile()" class="secondary">Add File</button>

    <div class="button-group">
        <button type="submit">Save Paste</button>
        {% if not isNew %}
            <a href="{{ paste.getHtmlUrl() }}" class="button secondary">Cancel</a>
        {% endif %}
    </div>
</form>

<script>
let fileIndex = {{ meta.files|length }};

function addFile() {
    const container = document.getElementById('files-container');
    const fileEditor = document.createElement('div');
    fileEditor.className = 'file-editor';
    fileEditor.setAttribute('data-file-index', fileIndex);
    fileEditor.setAttribute('draggable', 'true');
    fileEditor.setAttribute('ondragstart', 'handleDragStart(event)');
    fileEditor.setAttribute('ondragover', 'handleDragOver(event)');
    fileEditor.setAttribute('ondrop', 'handleDrop(event)');
    fileEditor.setAttribute('ondragend', 'handleDragEnd(event)');

    fileEditor.innerHTML = `
        <div class="file-editor-header" onclick="toggleFileEditor(event, this)">
            <div class="file-editor-header-left">
                <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                <span class="collapse-icon">▼</span>
                <h3>File #${fileIndex + 1}</h3>
                <span class="file-editor-names"></span>
            </div>
            <button type="button" class="secondary" onclick="event.stopPropagation(); removeFile(this)">Remove</button>
        </div>

        <div class="file-editor-body">
        <div class="inline-fields">
            <div class="form-group">
                <label>Filename</label>
                <input type="text" name="files[${fileIndex}][filename]" required oninput="updateDisplayFileDropdown()">
            </div>

            <div class="form-group">
                <label>Render Mode</label>
                <select name="files[${fileIndex}][render]" class="render-select" onchange="updateFileFields(this)">
                    <option value="plain">Plain</option>
                    <option value="highlighted" selected>Highlighted</option>
                    <option value="rendered">Rendered</option>
                    <option value="image">Image</option>
                    <option value="file">File Download</option>
                    <option value="file-link">File Link</option>
                    <option value="link">List of Links</option>
                </select>
            </div>

            <div class="form-group file-type-field">
                <label>Type</label>
                <select name="files[${fileIndex}][type]" class="type-select">
                    <option value="">Auto-detect</option>
                    <option value="bash">Bash</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                    <option value="csharp">C#</option>
                    <option value="css">CSS</option>
                    <option value="diff">Diff</option>
                    <option value="go">Go</option>
                    <option value="html">HTML</option>
                    <option value="java">Java</option>
                    <option value="javascript">JavaScript</option>
                    <option value="json">JSON</option>
                    <option value="kotlin">Kotlin</option>
                    <option value="markdown">Markdown</option>
                    <option value="php">PHP</option>
                    <option value="python">Python</option>
                    <option value="ruby">Ruby</option>
                    <option value="rust">Rust</option>
                    <option value="sql">SQL</option>
                    <option value="swift">Swift</option>
                    <option value="typescript">TypeScript</option>
                    <option value="xml">XML</option>
                    <option value="yaml">YAML</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="files[${fileIndex}][displayName]">Display Name (optional)</label>
            <input type="text" id="files[${fileIndex}][displayName]" name="files[${fileIndex}][displayName]" placeholder="Leave empty to use filename" oninput="updateDisplayFileDropdown()">
        </div>

        <div class="form-group">
            <label>Description</label>
            <input type="text" name="files[${fileIndex}][description]">
        </div>

        <div class="form-group">
            <div class="checkbox-field">
                <input type="checkbox" id="files[${fileIndex}][hidden]" name="files[${fileIndex}][hidden]" value="1">
                <label for="files[${fileIndex}][hidden]">Hidden (don't show in multi-file mode)</label>
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-field">
                <input type="checkbox" id="files[${fileIndex}][unwrapped]" name="files[${fileIndex}][unwrapped]" value="1">
                <label for="files[${fileIndex}][unwrapped]">Unwrapped (render without file header/wrapper)</label>
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-field">
                <input type="checkbox" id="files[${fileIndex}][collapsed]" name="files[${fileIndex}][collapsed]" value="1">
                <label for="files[${fileIndex}][collapsed]">Start collapsed (multi-file mode)</label>
            </div>
        </div>

        <div class="form-group">
            <label for="files[${fileIndex}][collapsedDescription]">Collapsed Description (optional)</label>
            <input type="text" id="files[${fileIndex}][collapsedDescription]" name="files[${fileIndex}][collapsedDescription]" placeholder="Brief description shown when collapsed">
        </div>

        <div class="form-group file-content-field">
            <label>Content (or upload file below)</label>
            <textarea name="files[${fileIndex}][content]" rows="10"></textarea>
        </div>

        <div class="form-group">
            <label>Or Upload File</label>
            <input type="file" name="file_uploads[${fileIndex}]">
        </div>
        </div>
    `;

    container.appendChild(fileEditor);

    // Initialize field visibility for new file
    const renderSelect = fileEditor.querySelector('.render-select');
    updateFileFields(renderSelect);

    // Update display file dropdown to include new file
    updateDisplayFileDropdown();

    fileIndex++;
}

function removeFile(button) {
    button.closest('.file-editor').remove();

    // Update display file dropdown to remove deleted file
    updateDisplayFileDropdown();
}

function updateFileFields(renderSelect) {
    const fileEditor = renderSelect.closest('.file-editor');
    const renderMode = renderSelect.value;
    const typeField = fileEditor.querySelector('.file-type-field');
    const contentField = fileEditor.querySelector('.file-content-field');
    const fileExistsIndicator = fileEditor.querySelector('.file-exists-indicator');
    const typeSelect = fileEditor.querySelector('.type-select');

    // Hide type for image/file/file-link/link modes
    if (renderMode === 'image' || renderMode === 'file' || renderMode === 'file-link' || renderMode === 'link') {
        typeField.classList.add('hidden');
        // Set type to match render mode
        typeSelect.value = renderMode;
    } else {
        typeField.classList.remove('hidden');
        // If current type value is not valid for this dropdown, reset to auto-detect
        const currentValue = typeSelect.value;

        // Check if the current value is one of the special render types that shouldn't be in the type dropdown
        // Also check for '' which happens when an invalid value was set (browser returns '' for invalid values)
        if (['', 'image', 'file', 'file-link', 'link'].includes(currentValue)) {
            typeSelect.value = ''; // Reset to Auto-detect
        }
    }

    // Hide content for image/file/file-link modes (but not link - that needs content)
    // However, if there's content in the textarea (text file), show it anyway
    if (renderMode === 'image' || renderMode === 'file' || renderMode === 'file-link') {
        const textarea = contentField.querySelector('textarea');
        const hasContent = textarea && textarea.value.trim().length > 0;

        if (hasContent) {
            // Text file - show content field, hide indicator
            contentField.classList.remove('hidden');
            if (fileExistsIndicator) {
                fileExistsIndicator.classList.add('hidden');
            }
        } else {
            // Binary file or no existing file - hide content, show indicator
            contentField.classList.add('hidden');
            if (fileExistsIndicator) {
                fileExistsIndicator.classList.remove('hidden');
            }
        }
    } else {
        contentField.classList.remove('hidden');
        // Hide file exists indicator
        if (fileExistsIndicator) {
            fileExistsIndicator.classList.add('hidden');
        }
    }
}

function updateDisplayModeFields() {
    const displayMode = document.getElementById('displayMode').value;
    const selectedFileGroup = document.getElementById('selectedFileGroup');

    // Show file selector only for single-file modes
    if (displayMode === 'single-normal' || displayMode === 'single-wide') {
        selectedFileGroup.classList.remove('hidden');
    } else {
        selectedFileGroup.classList.add('hidden');
    }
}

function toggleFileEditor(event, header) {
    const fileEditor = header.closest('.file-editor');
    const icon = header.querySelector('.collapse-icon');
    const namesSpan = header.querySelector('.file-editor-names');

    if (fileEditor.classList.contains('collapsed')) {
        // Expand
        fileEditor.classList.remove('collapsed');
        icon.textContent = '▼';
        namesSpan.textContent = '';
    } else {
        // Collapse - show filename and display name
        const filenameInput = fileEditor.querySelector('input[name*="[filename]"]');
        const displayNameInput = fileEditor.querySelector('input[name*="[displayName]"]');
        const hiddenCheckbox = fileEditor.querySelector('input[name*="[hidden]"]');

        let names = '';
        if (filenameInput && filenameInput.value) {
            names = filenameInput.value;
            if (displayNameInput && displayNameInput.value) {
                names += ' (' + displayNameInput.value + ')';
            }
        }

        // Add hidden indicator if checkbox is checked
        let hiddenIndicator = '';
        if (hiddenCheckbox && hiddenCheckbox.checked) {
            hiddenIndicator = ' <span class="file-hidden-indicator">[Hidden]</span>';
        }

        fileEditor.classList.add('collapsed');
        icon.textContent = '►︎';
        namesSpan.innerHTML = names ? ' - ' + names + hiddenIndicator : '';
    }
}

// Drag and drop functionality
let draggedElement = null;

function handleDragStart(event) {
    draggedElement = event.target.closest('.file-editor');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/html', draggedElement.innerHTML);
    draggedElement.classList.add('dragging');
}

function handleDragOver(event) {
    if (event.preventDefault) {
        event.preventDefault();
    }
    event.dataTransfer.dropEffect = 'move';

    const targetElement = event.target.closest('.file-editor');
    if (targetElement && targetElement !== draggedElement) {
        const container = document.getElementById('files-container');
        const allEditors = Array.from(container.querySelectorAll('.file-editor'));
        const draggedIndex = allEditors.indexOf(draggedElement);
        const targetIndex = allEditors.indexOf(targetElement);

        if (draggedIndex < targetIndex) {
            targetElement.parentNode.insertBefore(draggedElement, targetElement.nextSibling);
        } else {
            targetElement.parentNode.insertBefore(draggedElement, targetElement);
        }
    }

    return false;
}

function handleDrop(event) {
    if (event.stopPropagation) {
        event.stopPropagation();
    }
    return false;
}

function handleDragEnd(event) {
    draggedElement.classList.remove('dragging');
    draggedElement = null;

    // Renumber all files and update form field indices
    const container = document.getElementById('files-container');
    const allEditors = container.querySelectorAll('.file-editor');
    allEditors.forEach((editor, index) => {
        // Update visual file number
        const h3 = editor.querySelector('h3');
        if (h3) {
            h3.textContent = 'File #' + (index + 1);
        }

        // Update data attribute
        editor.setAttribute('data-file-index', index);

        // Update all form field names to use new index
        editor.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.name && field.name.startsWith('files[')) {
                // Replace files[oldIndex] with files[newIndex]
                field.name = field.name.replace(/^files\[\d+\]/, `files[${index}]`);

                // Update id if it exists and follows the same pattern
                if (field.id && field.id.startsWith('files[')) {
                    field.id = field.id.replace(/^files\[\d+\]/, `files[${index}]`);
                }
            } else if (field.name && field.name.startsWith('file_uploads[')) {
                // Update file upload field names too
                field.name = field.name.replace(/^file_uploads\[\d+\]/, `file_uploads[${index}]`);
            }
        });

        // Update labels that reference file fields
        editor.querySelectorAll('label').forEach(label => {
            if (label.htmlFor && label.htmlFor.startsWith('files[')) {
                label.htmlFor = label.htmlFor.replace(/^files\[\d+\]/, `files[${index}]`);
            }
        });
    });

    // Update the display file dropdown to reflect new order
    updateDisplayFileDropdown();
}

function updateDisplayFileDropdown() {
    const selectedFileSelect = document.getElementById('selectedFile');
    if (!selectedFileSelect) return;

    const currentValue = selectedFileSelect.value;
    const currentSelectedIndex = selectedFileSelect.selectedIndex;
    const container = document.getElementById('files-container');
    const allEditors = container.querySelectorAll('.file-editor');

    // Clear existing options
    selectedFileSelect.innerHTML = '';

    // Rebuild options in new order
    let matchFound = false;
    allEditors.forEach((editor, index) => {
        const filenameInput = editor.querySelector('input[name*="[filename]"]');
        const displayNameInput = editor.querySelector('input[name*="[displayName]"]');

        if (filenameInput) {
            const option = document.createElement('option');
            option.value = filenameInput.value || '';
            option.textContent = `${index + 1}. ${filenameInput.value || 'unnamed'}`;

            if (displayNameInput && displayNameInput.value) {
                option.textContent += ` (${displayNameInput.value})`;
            }

            // Try to restore selection by matching filename first
            if (filenameInput.value && filenameInput.value === currentValue) {
                option.selected = true;
                matchFound = true;
            }

            selectedFileSelect.appendChild(option);
        }
    });

    // If no match was found by filename, restore by index position
    if (!matchFound && currentSelectedIndex >= 0 && currentSelectedIndex < selectedFileSelect.options.length) {
        selectedFileSelect.selectedIndex = currentSelectedIndex;
    }
}

// Initialize field visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.render-select').forEach(function(select) {
        updateFileFields(select);
    });
    updateDisplayModeFields();
});
</script>
{% endblock %}
